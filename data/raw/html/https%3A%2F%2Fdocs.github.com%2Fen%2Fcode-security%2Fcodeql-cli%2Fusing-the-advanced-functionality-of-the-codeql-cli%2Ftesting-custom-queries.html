<html><body><div>
<main><div>
<div><nav><ul>
<li>
<a title="Secure coding" href="/en/code-security">Secure coding</a><span>/</span>
</li>
<li>
<a title="CodeQL CLI" href="/en/code-security/codeql-cli">CodeQL CLI</a><span>/</span>
</li>
<li>
<a title="Advanced functionality" href="/en/code-security/codeql-cli/using-the-advanced-functionality-of-the-codeql-cli">Advanced functionality</a><span>/</span>
</li>
<li><a title="Testing custom queries" href="/en/code-security/codeql-cli/using-the-advanced-functionality-of-the-codeql-cli/testing-custom-queries">Testing custom queries</a></li>
</ul></nav></div>
<div>
<div><div><h1>Testing custom queries</h1></div></div>
<div>
<div><p>You can set up tests for your CodeQL queries to ensure that they continue to return the expected results with new releases of the CodeQL CLI.</p></div>
<div><div>
<div><h2>Who can use this feature?</h2></div>
<div><div>
<p>CodeQL is available for the following repository types:</p>
<ul>
<li>Public repositories on GitHub.com, see <a href="https://github.com/github/codeql-cli-binaries/blob/main/LICENSE.md">GitHub CodeQL Terms and Conditions</a>
</li>
<li>Organization-owned repositories on GitHub Team with <a href="/en/get-started/learning-about-github/about-github-advanced-security">GitHub Code Security</a> enabled</li>
</ul>
</div></div>
</div></div>
</div>
<div>
<h2>In this article</h2>
<nav><ul>
<li><a href="#about-testing-custom-queries"><div><span>About testing custom queries</span></div></a></li>
<li><a href="#setting-up-a-test-codeql-pack-for-custom-queries"><div><span>Setting up a test CodeQL pack for custom queries</span></div></a></li>
<li><a href="#setting-up-the-test-files-for-a-query"><div><span>Setting up the test files for a query</span></div></a></li>
<li><a href="#running-codeql-test-run"><div><span>Running codeql test run</span></div></a></li>
<li><a href="#example"><div><span>Example</span></div></a></li>
<li><a href="#further-reading"><div><span>Further reading</span></div></a></li>
</ul></nav>
</div>
<div><div><div>
<h2><a href="#about-testing-custom-queries">About testing custom queries</a></h2>
<p>CodeQL provides a simple test framework for automated regression testing
of queries. Test your queries to ensure that they behave as expected.</p>
<p>During a query test, CodeQL compares the results the user expects
the query to produce with those actually produced. If the expected and
actual results differ, the query test fails. To fix the test, you should iterate
on the query and the expected results until the actual results and the expected
results exactly match. This topic shows you how to create test files and execute
tests on them using the <code>test run</code> subcommand.</p>
<h2><a href="#setting-up-a-test-codeql-pack-for-custom-queries">Setting up a test CodeQL pack for custom queries</a></h2>
<p>All CodeQL tests must be stored in a special "test" CodeQL pack. That is, a directory for test files with a <code>qlpack.yml</code> file that defines:</p>
<pre><code><span>name:</span> <span>&lt;name-of-test-pack&gt;</span>
<span>version:</span> <span>0.0</span><span>.0</span>
<span>dependencies:</span>
  <span>&lt;codeql-libraries-and-queries-to-test&gt;:</span> <span>"*"</span>
<span>extractor:</span> <span>&lt;language-of-code-to-test&gt;</span>
</code></pre>
<p>The <code>dependencies</code> value specifies the CodeQL packs containing queries to test.
Typically, these packs will be resolved from source, and so it is not necessary
to specify a fixed version of the pack. The <code>extractor</code> defines which language the CLI will use to create test databases from the code files stored in this CodeQL pack. For more information, see <a href="/en/code-security/codeql-cli/getting-started-with-the-codeql-cli/customizing-analysis-with-codeql-packs">Customizing analysis with CodeQL packs</a>.</p>
<p>You may find it useful to look at the way query tests are organized in the <a href="https://github.com/github/codeql">CodeQL repository</a>. Each language has a <code>src</code> directory, <code>ql/&lt;language&gt;/ql/src</code>, that contains libraries and queries for analyzing codebases. Alongside the <code>src</code> directory, there is a <code>test</code> directory with tests for
these libraries and queries.</p>
<p>Each <code>test</code> directory is configured as a test CodeQL pack with two subdirectories:</p>
<ul>
<li>
<code>query-tests</code> a series of subdirectories with tests for queries stored in the <code>src</code> directory. Each subdirectory contains test code and a QL reference file that specifies the query to test.</li>
<li>
<code>library-tests</code> a series of subdirectories with tests for QL library files. Each subdirectory contains test code and queries that were written as unit tests for a library.</li>
</ul>
<p>After creating the <code>qlpack.yml</code> file, you need to make sure that all of the dependencies are downloaded and available to the CLI. Do this by running the following command in the same directory as the <code>qlpack.yml</code> file:</p>
<pre><code>codeql pack install
</code></pre>
<p>This will generate a <code>codeql-pack.lock.yml</code> file that specifies all of the transitive dependencies required to run queries in this pack. This file should be checked in to source control.</p>
<h2><a href="#setting-up-the-test-files-for-a-query">Setting up the test files for a query</a></h2>
<p>For each query you want to test, you should create a sub-directory in the test CodeQL pack.
Then add the following files to the subdirectory before you run the test command:</p>
<ul>
<li>
<p>A query reference file (<code>.qlref</code> file) defining the location of the query to test. The location is defined relative to the root of the CodeQL pack that contains the query. Usually, this is a CodeQL pack specified in the <code>dependencies</code> block of the test pack. For more information, see <a href="/en/code-security/codeql-cli/using-the-advanced-functionality-of-the-codeql-cli/query-reference-files">Query reference files</a>.</p>
<p>You do not need to add a query reference file if the query you want to test is stored in the test directory, but it is generally good practice to store queries separately from tests. The only exception is unit tests for QL libraries, which tend to be stored in test packs, separate from queries that generate alerts or paths.</p>
</li>
<li>
<p>The example code you want to run your query against. This should consist of one or more files containing examples of the code the query is designed to identify.</p>
</li>
</ul>
<p>You can also define the results you expect to see when you run the query against
the example code, by creating a file with the extension <code>.expected</code>. Alternatively, you can leave the test command to create the <code>.expected</code> file for you.</p>
<p>For an example showing how to create and test a query, see the <a href="#example">example</a> below.</p>
<div>
<p>
Your <code>.ql</code>, <code>.qlref</code>, and <code>.expected</code> files must have consistent names:</p>
<ul>
<li>If you want to directly specify the <code>.ql</code> file itself in the test command, it must have the same base name as the corresponding <code>.expected</code> file. For example, if the query is <code>MyJavaQuery.ql</code>, the expected results file must be <code>MyJavaQuery.expected</code>.</li>
<li>If you want to specify a <code>.qlref</code> file in the command, it must have the same base name as the corresponding <code>.expected</code> file, but the query itself may have a different name.</li>
<li>The names of the example code files don’t have to be consistent with the other test files. All example code files found next to the <code>.qlref</code> (or <code>.ql</code>) file and in any subdirectories will be used to create a test database. Therefore, for simplicity, we recommend you don’t save test files in directories that are ancestors of each other.</li>
</ul>
</div>
<h2><a href="#running-codeql-test-run">Running <code>codeql test run</code></a></h2>
<p>CodeQL query tests are executed by running the following command:</p>
<pre><code>codeql test run &lt;test|dir&gt;
</code></pre>
<p>The <code>&lt;test|dir&gt;</code> argument can be one or more of the following:</p>
<ul>
<li>Path to a <code>.ql</code> file.</li>
<li>Path to a <code>.qlref</code> file that references a <code>.ql</code> file.</li>
<li>Path to a directory that will be searched recursively for <code>.ql</code> and <code>.qlref</code> files.</li>
</ul>
<p>You can also specify:</p>
<ul>
<li>
<code>--threads:</code> optionally, the number of threads to use when running queries. The default option is <code>1</code>. You can specify more threads to speed up query execution. Specifying <code>0</code> matches the number of threads to the number of logical processors.</li>
</ul>
<p>For full details of all the options you can use when testing queries, see <a href="/en/code-security/codeql-cli/codeql-cli-manual/test-run">test run</a>.</p>
<h2><a href="#example">Example</a></h2>
<p>The following example shows you how to set up a test for a query that searches
Java code for <code>if</code> statements that have empty <code>then</code> blocks. It includes
steps to add the custom query and corresponding test files to separate CodeQL packs
outside your checkout of the CodeQL repository. This ensures when you update the
CodeQL libraries, or check out a different branch, you won’t overwrite your
custom queries and tests.</p>
<h3><a href="#prepare-a-query-and-test-files">Prepare a query and test files</a></h3>
<ol>
<li>
<p>Develop the query. For example, the following simple query finds empty <code>then</code>
blocks in Java code:</p>
<pre><code>import java

from IfStmt ifstmt
where ifstmt.getThen() instanceof EmptyStmt
select ifstmt, "This if statement has an empty then."
</code></pre>
</li>
<li>
<p>Save the query to a file named <code>EmptyThen.ql</code> in a directory with your
other custom queries. For example, <code>custom-queries/java/queries/EmptyThen.ql</code>.</p>
</li>
<li>
<p>If you haven’t already added your custom queries to a CodeQL pack, create a CodeQL pack now. For example, if your custom Java queries are stored in <code>custom-queries/java/queries</code>, add a <code>qlpack.yml</code> file with the following contents to <code>custom-queries/java/queries</code>:</p>
<pre><code><span>name:</span> <span>my-custom-queries</span>
<span>dependencies:</span>
  <span>codeql/java-queries:</span> <span>"*"</span>
</code></pre>
<p>For more information about CodeQL packs, see <a href="/en/code-security/codeql-cli/getting-started-with-the-codeql-cli/customizing-analysis-with-codeql-packs">Customizing analysis with CodeQL packs</a>.</p>
</li>
<li>
<p>Create a CodeQL pack for your Java tests by adding a <code>qlpack.yml</code> file with the following contents to <code>custom-queries/java/tests</code>, updating the <code>dependencies</code> to match the name of your CodeQL pack of custom queries:</p>
<p>The following <code>qlpack.yml</code> file states that <code>my-github-user/my-query-tests</code> depends on <code>my-github-user/my-custom-queries</code> at a version greater than or equal to 1.2.3 and less than 2.0.0. It also declares that the CLI should use the Java <code>extractor</code> when creating test databases. The <code>tests: .</code> line declares that all <code>.ql</code> files in the pack should be run as tests when <code>codeql test run</code> is run with the <code>--strict-test-discovery</code> option. Typically, test packs do not contain a <code>version</code> property. This prevents you from accidentally publishing them.</p>
<pre><code><span>name:</span> <span>my-github-user/my-query-tests</span>
<span>dependencies:</span>
  <span>my-github-user/my-custom-queries:</span> <span>^1.2.3</span>
<span>extractor:</span> <span>java-kotlin</span>
<span>tests:</span> <span>.</span>
</code></pre>
</li>
<li>
<p>Run <code>codeql pack install</code> in the root of the test directory. This generates a <code>codeql-pack.lock.yml</code> file that specifies all of the transitive dependencies required to run queries in this pack.</p>
</li>
<li>
<p>Within the Java test pack, create a directory to contain the test files
associated with <code>EmptyThen.ql</code>. For example, <code>custom-queries/java/tests/EmptyThen</code>.</p>
</li>
<li>
<p>In the new directory, create <code>EmptyThen.qlref</code> to define the location of <code>EmptyThen.ql</code>. The path to the query must be specified relative to the root of
the CodeQL pack that contains the query. In this case, the query is in the
top level directory of the CodeQL pack named <code>my-custom-queries</code>,
which is declared as a dependency for <code>my-query-tests</code>. Therefore, <code>EmptyThen.qlref</code> should simply contain <code>EmptyThen.ql</code>.</p>
</li>
<li>
<p>Create a code snippet to test. The following Java code contains an empty <code>if</code> statement on the third line. Save it in <code>custom-queries/java/tests/EmptyThen/Test.java</code>.</p>
<pre><code><span>class</span> <span>Test</span> {
  <span>public</span> <span>void</span> <span>problem</span><span>(String arg)</span> {
    <span>if</span> (arg.isEmpty())
      ;
    {
      System.out.println(<span>"Empty argument"</span>);
    }
  }

  <span>public</span> <span>void</span> <span>good</span><span>(String arg)</span> {
    <span>if</span> (arg.isEmpty()) {
      System.out.println(<span>"Empty argument"</span>);
    }
  }
}
</code></pre>
</li>
</ol>
<h3><a href="#execute-the-test">Execute the test</a></h3>
<p>To execute the test, move into the <code>custom-queries</code> directory and run <code>codeql test run java/tests/EmptyThen</code>.</p>
<p>When the test runs, it:</p>
<ol>
<li>
<p>Finds one test in the <code>EmptyThen</code> directory.</p>
</li>
<li>
<p>Extracts a CodeQL database from the <code>.java</code> files stored in the <code>EmptyThen</code> directory.</p>
</li>
<li>
<p>Compiles the query referenced by the <code>EmptyThen.qlref</code> file.</p>
<p>If this step fails, it’s because the CLI can’t find your custom CodeQL pack. Re-run the command and specify the location of your custom CodeQL pack, for example:</p>
<p><code>codeql test run --search-path=java java/tests/EmptyThen</code></p>
<p>For information about saving the search path as part of your configuration, see <a href="/en/code-security/codeql-cli/using-the-advanced-functionality-of-the-codeql-cli/specifying-command-options-in-a-codeql-configuration-file">Specifying command options in a CodeQL configuration file</a>.</p>
</li>
<li>
<p>Executes the test by running the query and generating an <code>EmptyThen.actual</code> results file.</p>
</li>
<li>
<p>Checks for an <code>EmptyThen.expected</code> file to compare with the <code>.actual</code> results file.</p>
</li>
<li>
<p>Reports the results of the test — in this case, a failure: <code>0 tests passed; 1 tests failed:</code>. The test failed because we haven’t yet added a file with the expected results of the query.</p>
</li>
</ol>
<h3><a href="#view-the-query-test-output">View the query test output</a></h3>
<p>CodeQL generates the following files in the <code>EmptyThen</code> directory:</p>
<ul>
<li>
<code>EmptyThen.actual</code>, a file that contains the actual results generated by the
query.</li>
<li>
<code>EmptyThen.testproj</code>, a test database that you can load into VS Code and use to debug failing tests. When tests complete successfully, this database is deleted in a housekeeping step. You can override this step by running <code>test run</code> with the <code>--keep-databases</code> option.</li>
</ul>
<p>In this case, the failure was expected and is easy to fix. If you open the <code>EmptyThen.actual</code> file, you can see the results of the test:</p>
<pre><code>
| Test.java:3:5:3:22 | stmt | This if statement has an empty then. |

</code></pre>
<p>This file contains a table, with a column for the location of the result,
along with separate columns for each part of the <code>select</code> clause the query outputs.
Since the results are what we expected, we can update the file extension to define
this as the expected result for this test (<code>EmptyThen.expected</code>).</p>
<p>If you rerun the test now, the output will be similar but it will finish by reporting: <code>All 1 tests passed.</code>.</p>
<p>If the results of the query change, for example, if you revise the <code>select</code> statement for the query, the test will fail. For failed results, the CLI output includes a unified diff of the <code>EmptyThen.expected</code> and <code>EmptyThen.actual</code> files.
This information may be sufficient to debug trivial test failures.</p>
<p>For failures that are harder to debug, you can import <code>EmptyThen.testproj</code>
into CodeQL for VS Code, execute <code>EmptyThen.ql</code>, and view the results in the
<code>Test.java</code> example code. For more information, see <a href="/en/code-security/codeql-for-vs-code/getting-started-with-codeql-for-vs-code/managing-codeql-databases#choosing-a-database-to-analyze">Managing CodeQL databases</a>.</p>
<h2><a href="#further-reading">Further reading</a></h2>
<ul>
<li><a href="https://codeql.github.com/docs/writing-codeql-queries/codeql-queries/#codeql-queries">CodeQL queries</a></li>
<li>
<a href="/en/code-security/codeql-for-vs-code/using-the-advanced-functionality-of-the-codeql-for-vs-code-extension/testing-codeql-queries-in-vs-code">Testing CodeQL queries in Visual Studio Code</a>.</li>
</ul>
</div></div></div>
</div>
</div></main>
</div></body></html>