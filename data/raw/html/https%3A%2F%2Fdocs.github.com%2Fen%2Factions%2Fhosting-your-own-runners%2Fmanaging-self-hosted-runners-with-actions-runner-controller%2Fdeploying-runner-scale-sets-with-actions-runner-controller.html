<html><body><div>
<main><div>
<div><nav><ul>
<li>
<a title="GitHub Actions" href="/en/actions">GitHub Actions</a><span>/</span>
</li>
<li>
<a title="Self-hosted runners" href="/en/actions/hosting-your-own-runners">Self-hosted runners</a><span>/</span>
</li>
<li>
<a title="Actions Runner Controller" href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller">Actions Runner Controller</a><span>/</span>
</li>
<li><a title="Deploying runner scale sets" href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/deploying-runner-scale-sets-with-actions-runner-controller">Deploying runner scale sets</a></li>
</ul></nav></div>
<div>
<div><div><h1>Deploying runner scale sets with Actions Runner Controller</h1></div></div>
<div><div><p>Learn how to deploy runner scale sets with Actions Runner Controller, and use advanced configuration options to tailor Actions Runner Controller to your needs.</p></div></div>
<div>
<h2>In this article</h2>
<nav><ul>
<li><a href="#about-runner-scale-sets"><div><span>About runner scale sets</span></div></a></li>
<li><a href="#deploying-a-runner-scale-set"><div><span>Deploying a runner scale set</span></div></a></li>
<li><a href="#using-advanced-configuration-options"><div><span>Using advanced configuration options</span></div></a></li>
<li><a href="#using-docker-in-docker-or-kubernetes-mode-for-containers"><div><span>Using Docker-in-Docker or Kubernetes mode for containers</span></div></a></li>
<li><a href="#enabling-metrics"><div><span>Enabling metrics</span></div></a></li>
<li><a href="#upgrading-arc"><div><span>Upgrading ARC</span></div></a></li>
<li><a href="#high-availability-and-automatic-failover"><div><span>High availability and automatic failover</span></div></a></li>
<li><a href="#using-arc-across-organizations"><div><span>Using ARC across organizations</span></div></a></li>
<li><a href="#legal-notice"><div><span>Legal notice</span></div></a></li>
</ul></nav>
</div>
<div><div><div>
<p><a href="#legal-notice">Legal notice</a></p>
<h2><a href="#about-runner-scale-sets">About runner scale sets</a></h2>
<p>Runner scale sets is a group of homogeneous runners that can be assigned jobs from GitHub Actions. The number of active runners owned by a runner scale set can be controlled by auto-scaling runner solutions such as Actions Runner Controller (ARC).</p>
<p>You can use runner groups to manage runner scale sets. Similar to self-hosted runners, you can add runner scale sets to existing runner groups. However, runner scale sets can belong to only one runner group at a time and can only have one label assigned to them. For more information on runner groups, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners/managing-access-to-self-hosted-runners-using-groups">Managing access to self-hosted runners using groups</a>.</p>
<p>To assign jobs to a runner scale set, you must configure your workflow to reference the runner scale set's name. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/using-actions-runner-controller-runners-in-a-workflow">Using Actions Runner Controller runners in a workflow</a>.</p>
<h2><a href="#deploying-a-runner-scale-set">Deploying a runner scale set</a></h2>
<p>To deploy a runner scale set, you must have ARC up and running. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/quickstart-for-actions-runner-controller">Quickstart for Actions Runner Controller</a>.</p>
<p>You can deploy runner scale sets with ARC's Helm charts or by deploying the necessary manifests. Using ARC's Helm charts is the preferred method, especially if you do not have prior experience using ARC.</p>
<div>
<ul>
<li>As a security best practice, create your runner pods in a different namespace than the namespace containing your operator pods.</li>
<li>As a security best practice, create Kubernetes secrets and pass the secret references. Passing your secrets in plain text via the CLI can pose a security risk.</li>
<li>We recommend running production workloads in isolation. GitHub Actions workflows are designed to run arbitrary code, and using a shared Kubernetes cluster for production workloads could pose a security risk.</li>
<li>Ensure you have implemented a way to collect and retain logs from the controller, listeners, and ephemeral runners.</li>
</ul>
</div>
<ol>
<li>
<p>To configure your runner scale set, run the following command in your terminal, using values from your ARC configuration.</p>
<p>When you run the command, keep the following in mind.</p>
<ul>
<li>
<p>Update the <code>INSTALLATION_NAME</code> value carefully. You will use the installation name as the value of <a href="/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on"><code>runs-on</code></a> in your workflows.</p>
</li>
<li>
<p>Update the <code>NAMESPACE</code> value to the location you want the runner pods to be created.</p>
</li>
<li>
<p>Set the <code>GITHUB_CONFIG_URL</code> value to the URL of your repository, organization, or enterprise. This is the entity that the runners will belong to.</p>
</li>
<li>
<p>This example command installs the latest version of the Helm chart. To install a specific version, you can pass the <code>--version</code> argument with the version of the chart you want to install. You can find the list of releases in the <a href="https://github.com/actions/actions-runner-controller/pkgs/container/actions-runner-controller-charts%2Fgha-runner-scale-set"><code>actions-runner-controller</code></a> repository.</p>
<div>
<header><span>Bash</span><pre>INSTALLATION_NAME="arc-runner-set"
NAMESPACE="arc-runners"
GITHUB_CONFIG_URL="https://github.com/&lt;your_enterprise/org/repo&gt;"
GITHUB_PAT="&lt;PAT&gt;"
helm install "${INSTALLATION_NAME}" \
    --namespace "${NAMESPACE}" \
    --create-namespace \
    --set githubConfigUrl="${GITHUB_CONFIG_URL}" \
    --set githubConfigSecret.github_token="${GITHUB_PAT}" \
    oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set
</pre></header><pre><code>INSTALLATION_NAME=<span>"arc-runner-set"</span>
NAMESPACE=<span>"arc-runners"</span>
GITHUB_CONFIG_URL=<span>"https://github.com/&lt;your_enterprise/org/repo&gt;"</span>
GITHUB_PAT=<span>"&lt;PAT&gt;"</span>
helm install <span>"<span>${INSTALLATION_NAME}</span>"</span> \
    --namespace <span>"<span>${NAMESPACE}</span>"</span> \
    --create-namespace \
    --<span>set</span> githubConfigUrl=<span>"<span>${GITHUB_CONFIG_URL}</span>"</span> \
    --<span>set</span> githubConfigSecret.github_token=<span>"<span>${GITHUB_PAT}</span>"</span> \
    oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set
</code></pre>
</div>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
</li>
</ul>
</li>
<li>
<p>To check your installation, run the following command in your terminal.</p>
<div>
<header><span>Bash</span><pre>helm list -A
</pre></header><pre><code>helm list -A
</code></pre>
</div>
<p>You should see an output similar to the following.</p>
<pre><code>NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                                       APP VERSION
arc             arc-systems     1               2023-04-12 11:45:59.152090536 +0000 UTC deployed        gha-runner-scale-set-controller-0.4.0       0.4.0
arc-runner-set  arc-systems     1               2023-04-12 11:46:13.451041354 +0000 UTC deployed        gha-runner-scale-set-0.4.0                  0.4.0
</code></pre>
</li>
<li>
<p>To check the manager pod, run the following command in your terminal.</p>
<div>
<header><span>Bash</span><pre>kubectl get pods -n arc-systems
</pre></header><pre><code>kubectl get pods -n arc-systems
</code></pre>
</div>
<p>If the installation was successful, the pods will show the <code>Running</code> status.</p>
<pre><code>NAME                                                   READY   STATUS    RESTARTS   AGE
arc-gha-runner-scale-set-controller-594cdc976f-m7cjs   1/1     Running   0          64s
arc-runner-set-754b578d-listener                       1/1     Running   0          12s
</code></pre>
</li>
</ol>
<p>If your installation was not successful, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/troubleshooting-actions-runner-controller-errors">Troubleshooting Actions Runner Controller errors</a> for troubleshooting information.</p>
<h2><a href="#using-advanced-configuration-options">Using advanced configuration options</a></h2>
<p>ARC offers several advanced configuration options.</p>
<h3><a href="#configuring-the-runner-scale-set-name">Configuring the runner scale set name</a></h3>
<div>
<p>
Runner scale set names are unique within the runner group they belong to. If you want to deploy multiple runner scale sets with the same name, they must belong to different runner groups.</p>
</div>
<p>To configure the runner scale set name, you can define an <code>INSTALLATION_NAME</code> or set the value of <code>runnerScaleSetName</code> in your copy of the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> file.</p>
<pre><code><span>## The name of the runner scale set to create, which defaults to the Helm release name</span>
<span>runnerScaleSetName:</span> <span>"my-runners"</span>
</code></pre>
<p>Make sure to pass the <code>values.yaml</code> file in your <code>helm install</code> command. See the <a href="https://helm.sh/docs/helm/helm_install/">Helm Install</a> documentation for more details.</p>
<h3><a href="#choosing-runner-destinations">Choosing runner destinations</a></h3>
<p>Runner scale sets can be deployed at the repository, organization, or enterprise levels.</p>
<p>To deploy runner scale sets to a specific level, set the value of <code>githubConfigUrl</code> in your copy of the <code>values.yaml</code> to the URL of your repository, organization, or enterprise.</p>
<p>The following example shows how to configure ARC to add runners to <code>octo-org/octo-repo</code>.</p>
<pre><code><span>githubConfigUrl:</span> <span>"https://github.com/octo-ent/octo-org/octo-repo"</span>
</code></pre>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#using-a-github-app-for-authentication">Using a GitHub App for authentication</a></h3>
<p>If you are not using enterprise-level runners, you can use GitHub Apps to authenticate with the GitHub API. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/authenticating-to-the-github-api">Authenticating to the GitHub API</a>.</p>
<div>
<p>
Given the security risk associated with exposing your private key in plain text in a file on disk, we recommend creating a Kubernetes secret and passing the reference instead.</p>
</div>
<p>You can either create a Kubernetes secret, or specify values in your <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> file.</p>
<h4><a href="#option-1-create-a-kubernetes-secret-recommended">Option 1: Create a Kubernetes secret (recommended)</a></h4>
<p>Once you have created your GitHub App, create a Kubernetes secret and pass the reference to that secret in your copy of the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> file.</p>
<div>
<p>
Create the secret in the same namespace where the <code>gha-runner-scale-set</code> chart is installed. In this example, the namespace is <code>arc-runners</code> to match the quickstart documentation. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/quickstart-for-actions-runner-controller#configuring-a-runner-scale-set">Quickstart for Actions Runner Controller</a>.</p>
</div>
<pre><code>kubectl create secret generic pre-defined-secret \
  --namespace=arc-runners \
  --from-literal=github_app_id=123456 \
  --from-literal=github_app_installation_id=654321 \
  --from-file=github_app_private_key=private-key.pem
</code></pre>
<p>In your copy of the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> pass the secret name as a reference.</p>
<pre><code><span>githubConfigSecret:</span> <span>pre-defined-secret</span>
</code></pre>
<h4><a href="#option-2-specify-values-in-your-valuesyaml-file">Option 2: Specify values in your <code>values.yaml</code> file</a></h4>
<p>Alternatively, you can specify the values of <code>app_id</code>, <code>installation_id</code> and <code>private_key</code> in your copy of the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> file.</p>
<pre><code><span>## githubConfigSecret is the Kubernetes secret to use when authenticating with GitHub API.</span>
<span>## You can choose to use a GitHub App or a personal access token (classic)</span>
<span>githubConfigSecret:</span>
  <span>## GitHub Apps Configuration</span>
  <span>## IDs must be strings, use quotes</span>
  <span>github_app_id:</span> <span>"123456"</span>
  <span>github_app_installation_id:</span> <span>"654321"</span>
  <span>github_app_private_key:</span> <span>|
    -----BEGIN RSA PRIVATE KEY-----
    ...
    HkVN9...
    ...
    -----END RSA PRIVATE KEY-----
</span></code></pre>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#managing-access-with-runner-groups">Managing access with runner groups</a></h3>
<p>You can use runner groups to control which organizations or repositories have access to your runner scale sets. For more information on runner groups, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners/managing-access-to-self-hosted-runners-using-groups">Managing access to self-hosted runners using groups</a>.</p>
<p>To add a runner scale set to a runner group, you must already have a runner group created. Then set the <code>runnerGroup</code> property in your copy of the <code>values.yaml</code> file. The following example adds a runner scale set to the Octo-Group runner group.</p>
<pre><code><span>runnerGroup:</span> <span>"Octo-Group"</span>
</code></pre>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#configuring-an-outbound-proxy">Configuring an outbound proxy</a></h3>
<p>To force HTTP traffic for the controller and runners to go through your outbound proxy, set the following properties in your Helm chart.</p>
<pre><code><span>proxy:</span>
  <span>http:</span>
    <span>url:</span> <span>http://proxy.com:1234</span>
    <span>credentialSecretRef:</span> <span>proxy-auth</span> <span># a Kubernetes secret with `username` and `password` keys</span>
  <span>https:</span>
    <span>url:</span> <span>http://proxy.com:1234</span>
    <span>credentialSecretRef:</span> <span>proxy-auth</span> <span># a Kubernetes secret with `username` and `password` keys</span>
  <span>noProxy:</span>
    <span>-</span> <span>example.com</span>
    <span>-</span> <span>example.org</span>
</code></pre>
<p>ARC supports using anonymous or authenticated proxies. If you use authenticated proxies, you will need to set the <code>credentialSecretRef</code> value to reference a Kubernetes secret. You can create a secret with your proxy credentials with the following command.</p>
<div>
<p>
Create the secret in the same namespace where the <code>gha-runner-scale-set</code> chart is installed. In this example, the namespace is <code>arc-runners</code> to match the quickstart documentation. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/quickstart-for-actions-runner-controller#configuring-a-runner-scale-set">Quickstart for Actions Runner Controller</a>.</p>
</div>
<div>
<header><span>Bash</span><pre>  kubectl create secret generic proxy-auth \
    --namespace=arc-runners \
    --from-literal=username=proxyUsername \
    --from-literal=password=proxyPassword \
</pre></header><pre><code>  kubectl create secret generic proxy-auth \
    --namespace=arc-runners \
    --from-literal=username=proxyUsername \
    --from-literal=password=proxyPassword \
</code></pre>
</div>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#setting-the-maximum-and-minimum-number-of-runners">Setting the maximum and minimum number of runners</a></h3>
<p>The <code>maxRunners</code> and <code>minRunners</code> properties provide you with a range of options to customize your ARC setup.</p>
<div>
<p>
ARC does not support scheduled maximum and minimum configurations. You can use a cronjob or any other scheduling solution to update the configuration on a schedule.</p>
</div>
<h4><a href="#example-unbounded-number-of-runners">Example: Unbounded number of runners</a></h4>
<p>If you comment out both the <code>maxRunners</code> and <code>minRunners</code> properties, ARC will scale up to the number of jobs assigned to the runner scale set and will scale down to 0 if there aren't any active jobs.</p>
<pre><code><span>## maxRunners is the max number of runners the auto scaling runner set will scale up to.</span>
<span># maxRunners: 0</span>

<span>## minRunners is the min number of idle runners. The target number of runners created will be</span>
<span>## calculated as a sum of minRunners and the number of jobs assigned to the scale set.</span>
<span># minRunners: 0</span>
</code></pre>
<h4><a href="#example-minimum-number-of-runners">Example: Minimum number of runners</a></h4>
<p>You can set the <code>minRunners</code> property to any number and ARC will make sure there is always the specified number of runners active and available to take jobs assigned to the runner scale set at all times.</p>
<pre><code><span>## maxRunners is the max number of runners the auto scaling runner set will scale up to.</span>
<span># maxRunners: 0</span>

<span>## minRunners is the min number of idle runners. The target number of runners created will be</span>
<span>## calculated as a sum of minRunners and the number of jobs assigned to the scale set.</span>
<span>minRunners:</span> <span>20</span>
</code></pre>
<h4><a href="#example-set-maximum-and-minimum-number-of-runners">Example: Set maximum and minimum number of runners</a></h4>
<p>In this configuration, Actions Runner Controller will scale up to a maximum of <code>30</code> runners and will scale down to <code>20</code> runners when the jobs are complete.</p>
<div>
<p>
The value of <code>minRunners</code> can never exceed that of <code>maxRunners</code>, unless <code>maxRunners</code> is commented out.</p>
</div>
<pre><code><span>## maxRunners is the max number of runners the auto scaling runner set will scale up to.</span>
<span>maxRunners:</span> <span>30</span>

<span>## minRunners is the min number of idle runners. The target number of runners created will be</span>
<span>## calculated as a sum of minRunners and the number of jobs assigned to the scale set.</span>
<span>minRunners:</span> <span>20</span>
</code></pre>
<h4><a href="#example-jobs-queue-draining">Example: Jobs queue draining</a></h4>
<p>In certain scenarios you might want to drain the jobs queue to troubleshoot a problem or to perform maintenance on your cluster. If you set both properties to <code>0</code>, Actions Runner Controller will not create new runner pods when new jobs are available and assigned.</p>
<pre><code><span>## maxRunners is the max number of runners the auto scaling runner set will scale up to.</span>
<span>maxRunners:</span> <span>0</span>

<span>## minRunners is the min number of idle runners. The target number of runners created will be</span>
<span>## calculated as a sum of minRunners and the number of jobs assigned to the scale set.</span>
<span>minRunners:</span> <span>0</span>
</code></pre>
<h3><a href="#custom-tls-certificates">Custom TLS certificates</a></h3>
<div>
<p>
If you are using a custom runner image that is not based on the <code>Debian</code> distribution, the following instructions will not work.</p>
</div>
<p>Some environments require TLS certificates that are signed by a custom certificate authority (CA). Since the custom certificate authority certificates are not bundled with the controller or runner containers, you must inject them into their respective trust stores.</p>
<pre><code><span>githubServerTLS:</span>
  <span>certificateFrom:</span>
    <span>configMapKeyRef:</span>
      <span>name:</span> <span>config-map-name</span>
      <span>key:</span> <span>ca.crt</span>
  <span>runnerMountPath:</span> <span>/usr/local/share/ca-certificates/</span>
</code></pre>
<p>When you do this, ensure you are using the Privacy Enhanced Mail (PEM) format and that the extension of your certificate is <code>.crt</code>. Anything else will be ignored.</p>
<p>The controller executes the following actions.</p>
<ul>
<li>Creates a <code>github-server-tls-cert</code> volume containing the certificate specified in <code>certificateFrom</code>.</li>
<li>Mounts that volume on path <code>runnerMountPath/&lt;certificate name&gt;</code>.</li>
<li>Sets the <code>NODE_EXTRA_CA_CERTS</code> environment variable to that same path.</li>
<li>Sets the <code>RUNNER_UPDATE_CA_CERTS</code> environment variable to <code>1</code> (as of version <code>2.303.0</code>, this will instruct the runner to reload certificates on the host).</li>
</ul>
<p>ARC observes values set in the runner pod template and does not overwrite them.</p>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#using-a-private-container-registry">Using a private container registry</a></h3>
<div>
<p>
This Actions Runner Controller customization option may be outside the scope of what GitHub Support can assist with and may cause unexpected behavior when configured incorrectly.</p>
<p>For more information about what GitHub Support can assist with, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/about-support-for-actions-runner-controller">About support for Actions Runner Controller</a>.</p>
</div>
<p>To use a private container registry, you can copy the controller image and runner image to your private container registry. Then configure the links to those images and set the <code>imagePullPolicy</code> and <code>imagePullSecrets</code> values.</p>
<h4><a href="#configuring-the-controller-image">Configuring the controller image</a></h4>
<p>You can update your copy of the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set-controller/values.yaml"><code>values.yaml</code></a> file and set the <code>image</code> properties as follows.</p>
<pre><code><span>image:</span>
  <span>repository:</span> <span>"custom-registry.io/gha-runner-scale-set-controller"</span>
  <span>pullPolicy:</span> <span>IfNotPresent</span>
  <span># Overrides the image tag whose default is the chart appVersion.</span>
  <span>tag:</span> <span>"0.4.0"</span>

<span>imagePullSecrets:</span>
  <span>-</span> <span>name:</span> <span>&lt;registry-secret-name&gt;</span>
</code></pre>
<p>The listener container inherits the <code>imagePullPolicy</code> defined for the controller.</p>
<h4><a href="#configuring-the-runner-image">Configuring the runner image</a></h4>
<p>You can update your copy of the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> file and set the <code>template.spec</code> properties as follows.</p>
<pre><code><span>template:</span>
  <span>spec:</span>
    <span>containers:</span>
      <span>-</span> <span>name:</span> <span>runner</span>
        <span>image:</span> <span>"custom-registry.io/actions-runner:latest"</span>
        <span>imagePullPolicy:</span> <span>Always</span>
        <span>command:</span> [<span>"/home/runner/run.sh"</span>]
    <span>imagePullSecrets:</span>
      <span>-</span> <span>name:</span> <span>&lt;registry-secret-name&gt;</span>
</code></pre>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#updating-the-pod-specification-for-the-runner-pod">Updating the pod specification for the runner pod</a></h3>
<div>
<p>
This Actions Runner Controller customization option may be outside the scope of what GitHub Support can assist with and may cause unexpected behavior when configured incorrectly.</p>
<p>For more information about what GitHub Support can assist with, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/about-support-for-actions-runner-controller">About support for Actions Runner Controller</a>.</p>
</div>
<p>You can fully customize the PodSpec of the runner pod and the controller will apply the configuration you specify. The following is an example pod specification.</p>
<pre><code><span>template:</span>
  <span>spec:</span>
    <span>containers:</span>
      <span>-</span> <span>name:</span> <span>runner</span>
        <span>image:</span> <span>ghcr.io/actions/actions-runner:latest</span>
        <span>command:</span> [<span>"/home/runner/run.sh"</span>]
        <span>resources:</span>
          <span>limits:</span>
            <span>cpu:</span> <span>500m</span>
            <span>memory:</span> <span>512Mi</span>
        <span>securityContext:</span>
          <span>readOnlyRootFilesystem:</span> <span>true</span>
          <span>allowPrivilegeEscalation:</span> <span>false</span>
          <span>capabilities:</span>
            <span>add:</span>
              <span>-</span> <span>NET_ADMIN</span>
</code></pre>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#updating-the-pod-specification-for-the-listener-pod">Updating the pod specification for the listener pod</a></h3>
<div>
<p>
This Actions Runner Controller customization option may be outside the scope of what GitHub Support can assist with and may cause unexpected behavior when configured incorrectly.</p>
<p>For more information about what GitHub Support can assist with, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/about-support-for-actions-runner-controller">About support for Actions Runner Controller</a>.</p>
</div>
<p>You can customize the PodSpec of the listener pod and the controller will apply the configuration you specify. The following is an example pod specification.</p>
<div>
<p>
It's important to not change the <code>listenerTemplate.spec.containers.name</code> value of the listener container. Otherwise, the configuration you specify will be applied to a new side-car container.</p>
</div>
<pre><code><span>listenerTemplate:</span>
  <span>spec:</span>
    <span>containers:</span>
    <span># If you change the name of the container, the configuration will not be applied to the listener,</span>
    <span># and it will be treated as a side-car container.</span>
    <span>-</span> <span>name:</span> <span>listener</span>
      <span>securityContext:</span>
        <span>runAsUser:</span> <span>1000</span>
      <span>resources:</span>
        <span>limits:</span>
          <span>cpu:</span> <span>"1"</span>
          <span>memory:</span> <span>1Gi</span>
        <span>requests:</span>
          <span>cpu:</span> <span>"1"</span>
          <span>memory:</span> <span>1Gi</span>
</code></pre>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h2><a href="#using-docker-in-docker-or-kubernetes-mode-for-containers">Using Docker-in-Docker or Kubernetes mode for containers</a></h2>
<div>
<p>
This Actions Runner Controller customization option may be outside the scope of what GitHub Support can assist with and may cause unexpected behavior when configured incorrectly.</p>
<p>For more information about what GitHub Support can assist with, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/about-support-for-actions-runner-controller">About support for Actions Runner Controller</a>.</p>
</div>
<p>If you are using container jobs and services or container actions, the <code>containerMode</code> value must be set to <code>dind</code> or <code>kubernetes</code>.</p>
<ul>
<li>For more information on container jobs and services, see <a href="/en/actions/using-jobs/running-jobs-in-a-container">Running jobs in a container</a>.</li>
<li>For more information on container actions, see <a href="/en/actions/creating-actions/creating-a-docker-container-action">Creating a Docker container action</a>.</li>
</ul>
<h3><a href="#using-docker-in-docker-mode">Using Docker-in-Docker mode</a></h3>
<div>
<p>
The Docker-in-Docker container requires privileged mode. For more information, see <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">Configure a Security Context for a Pod or Container</a> in the Kubernetes documentation.</p>
<p>By default, the <code>dind</code> container uses the <code>docker:dind</code> image, which runs the Docker daemon as root. You can replace this image with <code>docker:dind-rootless</code> as long as you are aware of the <a href="https://docs.docker.com/engine/security/rootless/#known-limitations">known limitations</a> and run the pods with <code>--privileged</code> mode. To learn how to customize the Docker-in-Docker configuration, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/deploying-runner-scale-sets-with-actions-runner-controller#customizing-container-modes">Customizing container modes</a>.</p>
</div>
<p>Docker-in-Docker mode is a configuration that allows you to run Docker inside a Docker container. In this configuration, for each runner pod created, ARC creates the following containers.</p>
<ul>
<li>An <code>init</code> container</li>
<li>A <code>runner</code> container</li>
<li>A <code>dind</code> container</li>
</ul>
<p>To enable Docker-in-Docker mode, set the <code>containerMode.type</code> to <code>dind</code> as follows.</p>
<pre><code><span>containerMode:</span>
  <span>type:</span> <span>"dind"</span>
</code></pre>
<p>The <code>template.spec</code> will be updated to the following default configuration.</p>
<pre><code><span>template:</span>
  <span>spec:</span>
    <span>initContainers:</span>
      <span>-</span> <span>name:</span> <span>init-dind-externals</span>
        <span>image:</span> <span>ghcr.io/actions/actions-runner:latest</span>
        <span>command:</span>
          [<span>"cp"</span>, <span>"-r"</span>, <span>"/home/runner/externals/."</span>, <span>"/home/runner/tmpDir/"</span>]
        <span>volumeMounts:</span>
          <span>-</span> <span>name:</span> <span>dind-externals</span>
            <span>mountPath:</span> <span>/home/runner/tmpDir</span>
    <span>containers:</span>
      <span>-</span> <span>name:</span> <span>runner</span>
        <span>image:</span> <span>ghcr.io/actions/actions-runner:latest</span>
        <span>command:</span> [<span>"/home/runner/run.sh"</span>]
        <span>env:</span>
          <span>-</span> <span>name:</span> <span>DOCKER_HOST</span>
            <span>value:</span> <span>unix:///var/run/docker.sock</span>
        <span>volumeMounts:</span>
          <span>-</span> <span>name:</span> <span>work</span>
            <span>mountPath:</span> <span>/home/runner/_work</span>
          <span>-</span> <span>name:</span> <span>dind-sock</span>
            <span>mountPath:</span> <span>/var/run</span>
      <span>-</span> <span>name:</span> <span>dind</span>
        <span>image:</span> <span>docker:dind</span>
        <span>args:</span>
          <span>-</span> <span>dockerd</span>
          <span>-</span> <span>--host=unix:///var/run/docker.sock</span>
          <span>-</span> <span>--group=$(DOCKER_GROUP_GID)</span>
        <span>env:</span>
          <span>-</span> <span>name:</span> <span>DOCKER_GROUP_GID</span>
            <span>value:</span> <span>"123"</span>
        <span>securityContext:</span>
          <span>privileged:</span> <span>true</span>
        <span>volumeMounts:</span>
          <span>-</span> <span>name:</span> <span>work</span>
            <span>mountPath:</span> <span>/home/runner/_work</span>
          <span>-</span> <span>name:</span> <span>dind-sock</span>
            <span>mountPath:</span> <span>/var/run</span>
          <span>-</span> <span>name:</span> <span>dind-externals</span>
            <span>mountPath:</span> <span>/home/runner/externals</span>
    <span>volumes:</span>
      <span>-</span> <span>name:</span> <span>work</span>
        <span>emptyDir:</span> {}
      <span>-</span> <span>name:</span> <span>dind-sock</span>
        <span>emptyDir:</span> {}
      <span>-</span> <span>name:</span> <span>dind-externals</span>
        <span>emptyDir:</span> {}
</code></pre>
<p>The values in <code>template.spec</code> are automatically injected and cannot be overridden. If you want to customize this setup, you must unset <code>containerMode.type</code>, then copy this configuration and apply it directly in your copy of the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> file.</p>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<h3><a href="#using-kubernetes-mode">Using Kubernetes mode</a></h3>
<p>In Kubernetes mode, ARC uses runner container hooks to create a new pod in the same namespace to run the service, container job, or action.</p>
<h4><a href="#prerequisites">Prerequisites</a></h4>
<p>Kubernetes mode relies on persistent volumes to share job details between the runner pod and the container job pod. For more information, see the <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volumes</a> section in the Kubernetes documentation.</p>
<p>To use Kubernetes mode, you must do the following.</p>
<ul>
<li>Create persistent volumes available for the runner pods to claim.</li>
<li>Use a solution to automatically provision persistent volumes on demand.</li>
</ul>
<p>For testing, you can use a solution like <a href="https://github.com/openebs/openebs">OpenEBS</a>.</p>
<h4><a href="#configuring-kubernetes-mode">Configuring Kubernetes mode</a></h4>
<p>To enable Kubernetes mode, set the <code>containerMode.type</code> to <code>kubernetes</code> in your <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> file.</p>
<pre><code><span>containerMode:</span>
  <span>type:</span> <span>"kubernetes"</span>
  <span>kubernetesModeWorkVolumeClaim:</span>
    <span>accessModes:</span> [<span>"ReadWriteOnce"</span>]
    <span>storageClassName:</span> <span>"dynamic-blob-storage"</span>
    <span>resources:</span>
      <span>requests:</span>
        <span>storage:</span> <span>1Gi</span>
</code></pre>
<p>For additional Helm configuration options, see <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/values.yaml"><code>values.yaml</code></a> in the ARC repository.</p>
<div>
<p>
When Kubernetes mode is enabled, workflows that are not configured with a container job will fail with an error similar to:</p>
<pre><code>Jobs without a job container are forbidden on this runner, please add a <span>'container:'</span> to your job or contact your self-hosted runner administrator.
</code></pre>
<p>To allow jobs without a job container to run, set <code>ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER</code> to <code>false</code> on your runner container. This instructs the runner to disable this check.</p>
<pre><code><span>template:</span>
  <span>spec:</span>
    <span>containers:</span>
      <span>-</span> <span>name:</span> <span>runner</span>
        <span>image:</span> <span>ghcr.io/actions/actions-runner:latest</span>
        <span>command:</span> [<span>"/home/runner/run.sh"</span>]
        <span>env:</span>
          <span>-</span> <span>name:</span> <span>ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER</span>
            <span>value:</span> <span>"false"</span>
</code></pre>
</div>
<h3><a href="#customizing-container-modes">Customizing container modes</a></h3>
<p>When you set the <code>containerMode</code> in the <code>values.yaml</code> file for the <a href="https://github.com/actions/actions-runner-controller/blob/5347e2c2c80fbc45be7390eab117e861d30776d1/charts/gha-runner-scale-set/values.yaml#L77"><code>gha-runner-scale-set</code> helm chart</a>, you can use either of the following values:</p>
<ul>
<li>
<code>dind</code> or</li>
<li><code>kubernetes</code></li>
</ul>
<p>Depending on which value you set for the <code>containerMode</code>, a configuration will automatically be injected into the <code>template</code> section of the <code>values.yaml</code> file for the <code>gha-runner-scale-set</code> helm chart.</p>
<ul>
<li>See the <a href="https://github.com/actions/actions-runner-controller/blob/5347e2c2c80fbc45be7390eab117e861d30776d1/charts/gha-runner-scale-set/values.yaml#L110"><code>dind</code> configuration</a>.</li>
<li>See the <a href="https://github.com/actions/actions-runner-controller/blob/5347e2c2c80fbc45be7390eab117e861d30776d1/charts/gha-runner-scale-set/values.yaml#L160"><code>kubernetes</code> configuration</a>.</li>
</ul>
<p>To customize the spec, comment out or remove <code>containerMode</code>, and append the configuration you want in the <code>template</code> section.</p>
<h4><a href="#example-running-dind-rootless">Example: running <code>dind-rootless</code></a></h4>
<p>Before deciding to run <code>dind-rootless</code>, make sure you are aware of <a href="https://docs.docker.com/engine/security/rootless/#known-limitations">known limitations</a>.</p>
<pre><code><span>## githubConfigUrl is the GitHub url for where you want to configure runners</span>
<span>## ex: https://github.com/myorg/myrepo or https://github.com/myorg</span>
<span>githubConfigUrl:</span> <span>"https://github.com/actions/actions-runner-controller"</span>

<span>## githubConfigSecret is the k8s secrets to use when auth with GitHub API.</span>
<span>## You can choose to use GitHub App or a PAT token</span>
<span>githubConfigSecret:</span> <span>my-super-safe-secret</span>

<span>## maxRunners is the max number of runners the autoscaling runner set will scale up to.</span>
<span>maxRunners:</span> <span>5</span>

<span>## minRunners is the min number of idle runners. The target number of runners created will be</span>
<span>## calculated as a sum of minRunners and the number of jobs assigned to the scale set.</span>
<span>minRunners:</span> <span>0</span>

<span>runnerGroup:</span> <span>"my-custom-runner-group"</span>

<span>## name of the runner scale set to create. Defaults to the helm release name</span>
<span>runnerScaleSetName:</span> <span>"my-awesome-scale-set"</span>

<span>## template is the PodSpec for each runner Pod</span>
<span>## For reference: https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/#PodSpec</span>
<span>template:</span>
  <span>spec:</span>
    <span>initContainers:</span>
    <span>-</span> <span>name:</span> <span>init-dind-externals</span>
      <span>image:</span> <span>ghcr.io/actions/actions-runner:latest</span>
      <span>command:</span> [<span>"cp"</span>, <span>"-r"</span>, <span>"/home/runner/externals/."</span>, <span>"/home/runner/tmpDir/"</span>]
      <span>volumeMounts:</span>
        <span>-</span> <span>name:</span> <span>dind-externals</span>
          <span>mountPath:</span> <span>/home/runner/tmpDir</span>
    <span>-</span> <span>name:</span> <span>init-dind-rootless</span>
      <span>image:</span> <span>docker:dind-rootless</span>
      <span>command:</span>
        <span>-</span> <span>sh</span>
        <span>-</span> <span>-c</span>
        <span>-</span> <span>|
          set -x
          cp -a /etc/. /dind-etc/
          echo 'runner:x:1001:1001:runner:/home/runner:/bin/ash' &gt;&gt; /dind-etc/passwd
          echo 'runner:x:1001:' &gt;&gt; /dind-etc/group
          echo 'runner:100000:65536' &gt;&gt; /dind-etc/subgid
          echo 'runner:100000:65536' &gt;&gt; /dind-etc/subuid
          chmod 755 /dind-etc;
          chmod u=rwx,g=rx+s,o=rx /dind-home
          chown 1001:1001 /dind-home
</span>      <span>securityContext:</span>
        <span>runAsUser:</span> <span>0</span>
      <span>volumeMounts:</span>
        <span>-</span> <span>mountPath:</span> <span>/dind-etc</span>
          <span>name:</span> <span>dind-etc</span>
        <span>-</span> <span>mountPath:</span> <span>/dind-home</span>
          <span>name:</span> <span>dind-home</span>
    <span>containers:</span>
    <span>-</span> <span>name:</span> <span>runner</span>
      <span>image:</span> <span>ghcr.io/actions/actions-runner:latest</span>
      <span>command:</span> [<span>"/home/runner/run.sh"</span>]
      <span>env:</span>
        <span>-</span> <span>name:</span> <span>DOCKER_HOST</span>
          <span>value:</span> <span>unix:///run/user/1001/docker.sock</span>
      <span>securityContext:</span>
        <span>privileged:</span> <span>true</span>
        <span>runAsUser:</span> <span>1001</span>
        <span>runAsGroup:</span> <span>1001</span>
      <span>volumeMounts:</span>
        <span>-</span> <span>name:</span> <span>work</span>
          <span>mountPath:</span> <span>/home/runner/_work</span>
        <span>-</span> <span>name:</span> <span>dind-sock</span>
          <span>mountPath:</span> <span>/run/user/1001</span>
    <span>-</span> <span>name:</span> <span>dind</span>
      <span>image:</span> <span>docker:dind-rootless</span>
      <span>args:</span>
        <span>-</span> <span>dockerd</span>
        <span>-</span> <span>--host=unix:///run/user/1001/docker.sock</span>
      <span>securityContext:</span>
        <span>privileged:</span> <span>true</span>
        <span>runAsUser:</span> <span>1001</span>
        <span>runAsGroup:</span> <span>1001</span>
      <span>volumeMounts:</span>
        <span>-</span> <span>name:</span> <span>work</span>
          <span>mountPath:</span> <span>/home/runner/_work</span>
        <span>-</span> <span>name:</span> <span>dind-sock</span>
          <span>mountPath:</span> <span>/run/user/1001</span>
        <span>-</span> <span>name:</span> <span>dind-externals</span>
          <span>mountPath:</span> <span>/home/runner/externals</span>
        <span>-</span> <span>name:</span> <span>dind-etc</span>
          <span>mountPath:</span> <span>/etc</span>
        <span>-</span> <span>name:</span> <span>dind-home</span>
          <span>mountPath:</span> <span>/home/runner</span>
    <span>volumes:</span>
    <span>-</span> <span>name:</span> <span>work</span>
      <span>emptyDir:</span> {}
    <span>-</span> <span>name:</span> <span>dind-externals</span>
      <span>emptyDir:</span> {}
    <span>-</span> <span>name:</span> <span>dind-sock</span>
      <span>emptyDir:</span> {}
    <span>-</span> <span>name:</span> <span>dind-etc</span>
      <span>emptyDir:</span> {}
    <span>-</span> <span>name:</span> <span>dind-home</span>
      <span>emptyDir:</span> {}
</code></pre>
<h4><a href="#understanding-runner-container-hooks">Understanding runner-container-hooks</a></h4>
<p>When the runner detects a workflow run that uses a container job, service container, or Docker action, it will call runner-container-hooks to create a new pod. The runner relies on runner-container-hooks to call the Kubernetes APIs and create a new pod in the same namespace as the runner pod. This newly created pod will be used to run the container job, service container, or Docker action. For more information, see the <a href="https://github.com/actions/runner-container-hooks"><code>runner-container-hooks</code></a> repository.</p>
<h4><a href="#configuring-hook-extensions">Configuring hook extensions</a></h4>
<p>As of ARC version 0.4.0, runner-container-hooks support hook extensions. You can use these to configure the pod created by runner-container-hooks. For example, you could use a hook extension to set a security context on the pod. Hook extensions allow you to specify a YAML file that is used to update the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#podspec-v1-core">PodSpec</a> of the pod created by runner-container-hooks.</p>
<p>There are two options to configure hook extensions.</p>
<ul>
<li>Store in your <strong>custom runner image</strong>. You can store the PodSpec in a YAML file anywhere in your custom runner image. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/about-actions-runner-controller#creating-your-own-runner-image">About Actions Runner Controller</a>.</li>
<li>Store in a <strong>ConfigMap</strong>. You can create a config map with the PodSpec and mount that config map in the runner container. For more information, see <a href="https://kubernetes.io/docs/concepts/configuration/configmap/">ConfigMaps</a> in the Kubernetes documentation.</li>
</ul>
<div>
<p>
With both options, you must set the <code>ACTIONS_RUNNER_CONTAINER_HOOK_TEMPLATE</code> environment variable in the runner container spec to point to the path of the YAML file mounted in the runner container.</p>
</div>
<h5><a href="#example-using-config-map-to-set-securitycontext">Example: Using config map to set securityContext</a></h5>
<p>Create a config map in the same namespace as the runner pods. For example:</p>
<pre><code><span>apiVersion:</span> <span>v1</span>
<span>kind:</span> <span>ConfigMap</span>
<span>metadata:</span>
  <span>name:</span> <span>hook-extension</span>
  <span>namespace:</span> <span>arc-runners</span>
<span>data:</span>
  <span>content:</span> <span>|
    metadata:
      annotations:
        example: "extension"
    spec:
      containers:
        - name: "$job" # Target the job container
          securityContext:
            runAsUser: 1000
</span></code></pre>
<ul>
<li>The <code>.metadata.labels</code> and <code>metadata.annotations</code> fields will be appended as is, unless their keys are reserved. You cannot override the <code>.metadata.name</code> and <code>metadata.namespace</code> fields.</li>
<li>The majority of the PodSpec fields are applied from the specified template, and will override the values passed from your Helm chart <code>values.yaml</code> file.</li>
<li>If you specify additional volumes they will be appended to the default volumes specified by the runner.</li>
<li>The <code>spec.containers</code> are merged based on the names assigned to them.
<ul>
<li>If the name of the container is <code>$job</code>:
<ul>
<li>The <code>spec.containers.name</code> and <code>spec.containers.image</code> fields are ignored.</li>
<li>The <code>spec.containers.env</code>, <code>spec.containers.volumeMounts</code>, and <code>spec.containers.ports</code> fields are appended to the default container spec created by the hook.</li>
<li>The rest of the fields are applied as provided.</li>
</ul>
</li>
<li>If the name of the container is not <code>$job</code>, the fields will be added to the pod definition as they are.</li>
</ul>
</li>
</ul>
<h2><a href="#enabling-metrics">Enabling metrics</a></h2>
<div>
<p>
Metrics for ARC are available as of version gha-runner-scale-set-0.5.0.</p>
</div>
<p>ARC can emit metrics about your runners, your jobs, and time spent on executing your workflows. Metrics can be used to identify congestion, monitor the health of your ARC deployment, visualize usage trends, optimize resource consumption, among many other use cases. Metrics are emitted by the controller-manager and listener pods in Prometheus format. For more information, see <a href="https://prometheus.io/docs/instrumenting/exposition_formats/">Exposition formats</a> in the Prometheus documentation.</p>
<p>To enable metrics for ARC, configure the <code>metrics</code> property in the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set-controller/values.yaml"><code>values.yaml</code></a> file of the <code>gha-runner-scale-set-controller</code> chart.</p>
<p>The following is an example configuration.</p>
<pre><code><span>metrics:</span>
  <span>controllerManagerAddr:</span> <span>":8080"</span>
  <span>listenerAddr:</span> <span>":8080"</span>
  <span>listenerEndpoint:</span> <span>"/metrics"</span>
</code></pre>
<div>
<p>
If the <code>metrics:</code> object is not provided or is commented out, the following flags will be applied to the controller-manager and listener pods with empty values: <code>--metrics-addr</code>, <code>--listener-metrics-addr</code>, <code>--listener-metrics-endpoint</code>. This will disable metrics for ARC.</p>
</div>
<p>Once these properties are configured, your controller-manager and listener pods emit metrics via the listenerEndpoint bound to the ports that you specify in your <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set-controller/values.yaml"><code>values.yaml</code></a> file. In the above example, the endpoint is <code>/metrics</code> and the port is <code>:8080</code>. You can use this endpoint to scrape metrics from your controller-manager and listener pods.</p>
<p>To turn off metrics, update your <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set-controller/values.yaml"><code>values.yaml</code></a> file by removing or commenting out the <code>metrics:</code> object and its properties.</p>
<h3><a href="#available-metrics-for-arc">Available metrics for ARC</a></h3>
<p>The following table shows the metrics emitted by the controller-manager and listener pods.</p>
<div>
<p>
The metrics that the controller-manager emits pertain to the controller runtime and are not owned by GitHub.</p>
</div>











































































































<table>
<thead><tr>
<th>Owner</th>
<th>Metric</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr>
<td>controller-manager</td>
<td>gha_controller_pending_ephemeral_runners</td>
<td>gauge</td>
<td>Number of ephemeral runners in a pending state</td>
</tr>
<tr>
<td>controller-manager</td>
<td>gha_controller_running_ephemeral_runners</td>
<td>gauge</td>
<td>Number of ephemeral runners in a running state</td>
</tr>
<tr>
<td>controller-manager</td>
<td>gha_controller_failed_ephemeral_runners</td>
<td>gauge</td>
<td>Number of ephemeral runners in a failed state</td>
</tr>
<tr>
<td>controller-manager</td>
<td>gha_controller_running_listeners</td>
<td>gauge</td>
<td>Number of listeners in a running state</td>
</tr>
<tr>
<td>listener</td>
<td>gha_assigned_jobs</td>
<td>gauge</td>
<td>Number of jobs assigned to the runner scale set</td>
</tr>
<tr>
<td>listener</td>
<td>gha_running_jobs</td>
<td>gauge</td>
<td>Number of jobs running or queued to run</td>
</tr>
<tr>
<td>listener</td>
<td>gha_registered_runners</td>
<td>gauge</td>
<td>Number of runners registered by the runner scale set</td>
</tr>
<tr>
<td>listener</td>
<td>gha_busy_runners</td>
<td>gauge</td>
<td>Number of registered runners currently running a job</td>
</tr>
<tr>
<td>listener</td>
<td>gha_min_runners</td>
<td>gauge</td>
<td>Minimum number of runners configured for the runner scale set</td>
</tr>
<tr>
<td>listener</td>
<td>gha_max_runners</td>
<td>gauge</td>
<td>Maximum number of runners configured for the runner scale set</td>
</tr>
<tr>
<td>listener</td>
<td>gha_desired_runners</td>
<td>gauge</td>
<td>Number of runners desired (scale up / down target) by the runner scale set</td>
</tr>
<tr>
<td>listener</td>
<td>gha_idle_runners</td>
<td>gauge</td>
<td>Number of registered runners not running a job</td>
</tr>
<tr>
<td>listener</td>
<td>gha_started_jobs_total</td>
<td>counter</td>
<td>Total number of jobs started since the listener became ready [1]</td>
</tr>
<tr>
<td>listener</td>
<td>gha_completed_jobs_total</td>
<td>counter</td>
<td>Total number of jobs completed since the listener became ready [1]</td>
</tr>
<tr>
<td>listener</td>
<td>gha_job_startup_duration_seconds</td>
<td>histogram</td>
<td>Number of seconds spent waiting for workflow job to get started on the runner owned by the runner scale set</td>
</tr>
<tr>
<td>listener</td>
<td>gha_job_execution_duration_seconds</td>
<td>histogram</td>
<td>Number of seconds spent executing workflow jobs by the runner scale set</td>
</tr>
</tbody>
</table>
<p>[1]: Listener metrics that have the counter type are reset when the listener pod restarts.</p>
<h2><a href="#upgrading-arc">Upgrading ARC</a></h2>
<p>Because there is no support for upgrading or deleting CRDs with Helm, it is not possible to use Helm to upgrade ARC. For more information, see <a href="https://helm.sh/docs/chart_best_practices/custom_resource_definitions/#some-caveats-and-explanations">Custom Resource Definitions</a> in the Helm documentation. To upgrade ARC to a newer version, you must complete the following steps.</p>
<ol>
<li>Uninstall all installations of <code>gha-runner-scale-set</code>.</li>
<li>Wait for resources cleanup.</li>
<li>Uninstall ARC.</li>
<li>If there is a change in CRDs from the version you currently have installed, to the upgraded version, remove all CRDs associated with <code>actions.github.com</code> API group.</li>
<li>Reinstall ARC again.</li>
</ol>
<p>For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/deploying-runner-scale-sets-with-actions-runner-controller#deploying-a-runner-scale-set">Deploying a runner scale set</a>.</p>
<p>If you would like to upgrade ARC but are concerned about downtime, you can deploy ARC in a high availability configuration to ensure runners are always available. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/deploying-runner-scale-sets-with-actions-runner-controller#high-availability-and-automatic-failover">High availability and automatic failover</a>.</p>
<div>
<p>
Transitioning from the <a href="https://github.com/actions/actions-runner-controller/discussions/2775">community supported version of ARC</a> to the GitHub supported version is a substantial architectural change. The GitHub supported version involves a redesign of many components of ARC. It is not a minor software upgrade. For these reasons, we recommend testing the new versions in a staging environment that matches your production environment first. This will ensure stability and reliability of the setup before deploying in production.</p>
</div>
<h3><a href="#deploying-a-canary-image">Deploying a canary image</a></h3>
<p>You can test features before they are released by using canary releases of the controller-manager container image. Canary images are published with tag format <code>canary-SHORT_SHA</code>. For more information, see <a href="https://github.com/actions/actions-runner-controller/pkgs/container/gha-runner-scale-set-controller"><code>gha-runner-scale-set-controller</code></a> on the Container registry.</p>
<div>
<ul>
<li>You must use Helm charts on your local file system.</li>
<li>You cannot use the released Helm charts.</li>
</ul>
</div>
<ol>
<li>Update the <code>tag</code> in the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set-controller/values.yaml">gha-runner-scale-set-controller <code>values.yaml</code></a> file to: <code>canary-SHORT_SHA</code>
</li>
<li>Update the field <code>appVersion</code> in the <a href="https://github.com/actions/actions-runner-controller/blob/master/charts/gha-runner-scale-set/Chart.yaml"><code>Chart.yaml</code></a> file for <code>gha-runner-scale-set</code> to: <code>canary-SHORT_SHA</code>
</li>
<li>Re-install ARC using the updated Helm chart and <code>values.yaml</code> files.</li>
</ol>
<h2><a href="#high-availability-and-automatic-failover">High availability and automatic failover</a></h2>
<p>ARC can be deployed in a high availability (active-active) configuration. If you have two distinct Kubernetes clusters deployed in separate regions, you can deploy ARC in both clusters and configure runner scale sets to use the same <code>runnerScaleSetName</code>. In order to do this, each runner scale set must be assigned to a distinct runner group. For example, you can have two runner scale sets each named <code>arc-runner-set</code>, as long as one runner scale set belongs to <code>runner-group-A</code> and the other runner scale set belongs to <code>runner-group-B</code>. For information on assigning runner scale sets to runner groups, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners/managing-access-to-self-hosted-runners-using-groups">Managing access to self-hosted runners using groups</a>.</p>
<p>If both runner scale sets are online, jobs assigned to them will be distributed arbitrarily (assignment race). You cannot configure the job assignment algorithm. If one of the clusters goes down, the runner scale set in the other cluster will continue to acquire jobs normally without any intervention or configuration change.</p>
<h2><a href="#using-arc-across-organizations">Using ARC across organizations</a></h2>
<p>A single installation of Actions Runner Controller allows you to configure one or more runner scale sets. These runner scale sets can be registered to a repository, organization, or enterprise. You can also use runner groups to control the permissions boundaries of these runner scale sets.</p>
<p>As a best practice, create a unique namespace for each organization. You could also create a namespace for each runner group or each runner scale set. You can install as many runner scale sets as needed in each namespace. This will provide you the highest levels of isolation and improve your security. You can use GitHub Apps for authentication and define granular permissions for each runner scale set.</p>
<h2><a href="#legal-notice">Legal notice</a></h2>
<p>Portions have been adapted from <a href="https://github.com/actions/actions-runner-controller/">https://github.com/actions/actions-runner-controller/</a> under the Apache-2.0 license:</p>
<pre><code>Copyright 2019 Moto Ishizawa

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
</code></pre>
</div></div></div>
</div>
</div></main>
</div></body></html>