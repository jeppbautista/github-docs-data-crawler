<html><body><div>
<main><div>
<div><nav><ul>
<li>
<a title="GitHub Actions" href="/en/actions">GitHub Actions</a><span>/</span>
</li>
<li>
<a title="Security" href="/en/actions/security-for-github-actions">Security</a><span>/</span>
</li>
<li>
<a title="Security harden deployments" href="/en/actions/security-for-github-actions/security-hardening-your-deployments">Security harden deployments</a><span>/</span>
</li>
<li><a title="OpenID Connect with reusable workflows" href="/en/actions/security-for-github-actions/security-hardening-your-deployments/using-openid-connect-with-reusable-workflows">OpenID Connect with reusable workflows</a></li>
</ul></nav></div>
<div>
<div><div><h1>Using OpenID Connect with reusable workflows</h1></div></div>
<div><div><p>You can use reusable workflows with OIDC to standardize and security harden your deployment steps.</p></div></div>
<div>
<h2>In this article</h2>
<nav><ul>
<li><a href="#about-reusable-workflows"><div><span>About reusable workflows</span></div></a></li>
<li><a href="#defining-the-trust-conditions"><div><span>Defining the trust conditions</span></div></a></li>
<li><a href="#how-the-token-works-with-reusable-workflows"><div><span>How the token works with reusable workflows</span></div></a></li>
<li><a href="#examples"><div><span>Examples</span></div></a></li>
</ul></nav>
</div>
<div><div><div>
<h2><a href="#about-reusable-workflows">About reusable workflows</a></h2>
<p>Rather than copying and pasting deployment jobs from one workflow to another, you can create a reusable workflow that performs the deployment steps. A reusable workflow can be used by another workflow if it meets one of the access requirements described in <a href="/en/actions/using-workflows/reusing-workflows#access-to-reusable-workflows">Reusing workflows</a>.</p>
<p>You should be familiar with the concepts described in <a href="/en/actions/using-workflows/reusing-workflows">Reusing workflows</a> and <a href="/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect">About security hardening with OpenID Connect</a>.</p>
<h2><a href="#defining-the-trust-conditions">Defining the trust conditions</a></h2>
<p>When combined with OpenID Connect (OIDC), reusable workflows let you enforce consistent deployments across your repository, organization, or enterprise. You can do this by defining trust conditions on cloud roles based on reusable workflows. The available options will vary depending on your cloud provider:</p>
<ul>
<li>
<p><strong>Using <code>job_workflow_ref</code>:</strong></p>
<ul>
<li>To create trust conditions based on reusable workflows, your cloud provider must support custom claims for <code>job_workflow_ref</code>. This allows your cloud provider to identify which repository the job originally came from.</li>
<li>For clouds that only support the standard claims (audience (<code>aud</code>) and subject (<code>sub</code>)), you can use the API to customize the <code>sub</code> claim to include <code>job_workflow_ref</code>. For more information, see <a href="/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#customizing-the-token-claims">About security hardening with OpenID Connect</a>. Support for custom claims is currently available for Google Cloud Platform and HashiCorp Vault.</li>
</ul>
</li>
<li>
<p><strong>Customizing the token claims:</strong></p>
<ul>
<li>You can configure more granular trust conditions by customizing the subject (<code>sub</code>) claim that's included with the JWT. For more information, see <a href="/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#customizing-the-token-claims">About security hardening with OpenID Connect</a>.</li>
</ul>
</li>
</ul>
<h2><a href="#how-the-token-works-with-reusable-workflows">How the token works with reusable workflows</a></h2>
<p>During a workflow run, GitHub's OIDC provider presents a OIDC token to the cloud provider which contains information about the job. If that job is part of a reusable workflow, the token will include the standard claims that contain information about the calling workflow, and will also include a custom claim called <code>job_workflow_ref</code> that contains information about the called workflow.</p>
<p>For example, the following OIDC token is for a job that was part of a called workflow. The <code>workflow</code>, <code>ref</code>, and other attributes describe the caller workflow, while <code>job_workflow_ref</code> refers to the called workflow:</p>
<div>
<header><span>YAML</span><pre>{
  "typ": "JWT",
  "alg": "RS256",
  "x5t": "example-thumbprint",
  "kid": "example-key-id"
}
{
  "jti": "example-id",
  "sub": "repo:octo-org/octo-repo:environment:prod",
  "aud": "https://github.com/octo-org",
  "ref": "refs/heads/main",
  "sha": "example-sha",
  "repository": "octo-org/octo-repo",
  "repository_owner": "octo-org",
  "actor_id": "12",
  "repository_id": "74",
  "repository_owner_id": "65",
  "run_id": "example-run-id",
  "run_number": "10",
  "run_attempt": "2",
  "actor": "octocat",
  "workflow": "example-workflow",
  "head_ref": "",
  "base_ref": "",
  "event_name": "workflow_dispatch",
  "ref_type": "branch",
  "job_workflow_ref": "octo-org/octo-automation/.github/workflows/oidc.yml@refs/heads/main",
  "iss": "https://token.actions.githubusercontent.com",
  "nbf": 1632492967,
  "exp": 1632493867,
  "iat": 1632493567
}
</pre></header><pre><code>{
  <span>"typ":</span> <span>"JWT"</span>,
  <span>"alg":</span> <span>"RS256"</span>,
  <span>"x5t":</span> <span>"example-thumbprint"</span>,
  <span>"kid":</span> <span>"example-key-id"</span>
}
{
  <span>"jti":</span> <span>"example-id"</span>,
  <span>"sub":</span> <span>"repo:octo-org/octo-repo:environment:prod"</span>,
  <span>"aud":</span> <span>"https://github.com/octo-org"</span>,
  <span>"ref":</span> <span>"refs/heads/main"</span>,
  <span>"sha":</span> <span>"example-sha"</span>,
  <span>"repository":</span> <span>"octo-org/octo-repo"</span>,
  <span>"repository_owner":</span> <span>"octo-org"</span>,
  <span>"actor_id":</span> <span>"12"</span>,
  <span>"repository_id":</span> <span>"74"</span>,
  <span>"repository_owner_id":</span> <span>"65"</span>,
  <span>"run_id":</span> <span>"example-run-id"</span>,
  <span>"run_number":</span> <span>"10"</span>,
  <span>"run_attempt":</span> <span>"2"</span>,
  <span>"actor":</span> <span>"octocat"</span>,
  <span>"workflow":</span> <span>"example-workflow"</span>,
  <span>"head_ref":</span> <span>""</span>,
  <span>"base_ref":</span> <span>""</span>,
  <span>"event_name":</span> <span>"workflow_dispatch"</span>,
  <span>"ref_type":</span> <span>"branch"</span>,
  <span>"job_workflow_ref":</span> <span>"octo-org/octo-automation/.github/workflows/oidc.yml@refs/heads/main"</span>,
  <span>"iss":</span> <span>"https://token.actions.githubusercontent.com"</span>,
  <span>"nbf":</span> <span>1632492967</span>,
  <span>"exp":</span> <span>1632493867</span>,
  <span>"iat":</span> <span>1632493567</span>
}
</code></pre>
</div>
<p>If your reusable workflow performs deployment steps, then it will typically need access to a specific cloud role, and you might want to allow any repository in your organization to call that reusable workflow. To permit this, you'll create the trust condition that allows any repository and any caller workflow, and then filter on the organization and the called workflow. See the next section for some examples.</p>
<h2><a href="#examples">Examples</a></h2>
<p><strong>Filtering for reusable workflows within a specific repository</strong></p>
<p>You can configure a custom claim that filters for any reusable workflow in a specific repository. In this example, the workflow run must have originated from a job defined in a reusable workflow in the <code>octo-org/octo-automation</code> repository, and in any repository that is owned by the <code>octo-org</code> organization.</p>
<ul>
<li>
<p><strong>Subject:</strong></p>
<ul>
<li>Syntax: <code>repo:ORG_NAME/*</code>
</li>
<li>Example: <code>repo:octo-org/*</code>
</li>
</ul>
</li>
<li>
<p><strong>Custom claim:</strong></p>
<ul>
<li>Syntax: <code>job_workflow_ref:ORG_NAME/REPO_NAME</code>
</li>
<li>Example: <code>job_workflow_ref:octo-org/octo-automation@*</code>
</li>
</ul>
</li>
</ul>
<p><strong>Filtering for a specific reusable workflow at a specific ref</strong></p>
<p>You can configure a custom claim that filters for a specific reusable workflow. In this example, the workflow run must have originated from a job defined in the reusable workflow <code>octo-org/octo-automation/.github/workflows/deployment.yml</code>, and in any repository that is owned by the <code>octo-org</code> organization.</p>
<ul>
<li>
<p><strong>Subject:</strong></p>
<ul>
<li>Syntax: <code>repo:ORG_NAME/*</code>
</li>
<li>Example: <code>repo:octo-org/*</code>
</li>
</ul>
</li>
<li>
<p><strong>Custom claim:</strong></p>
<ul>
<li>Syntax: <code>job_workflow_ref:ORG_NAME/REPO_NAME/.github/workflows/WORKFLOW_FILE@ref</code>
</li>
<li>Example: <code>job_workflow_ref:octo-org/octo-automation/.github/workflows/deployment.yml@ 10040c56a8c0253d69db7c1f26a0d227275512e2</code>
</li>
</ul>
</li>
</ul>
</div></div></div>
</div>
</div></main>
</div></body></html>