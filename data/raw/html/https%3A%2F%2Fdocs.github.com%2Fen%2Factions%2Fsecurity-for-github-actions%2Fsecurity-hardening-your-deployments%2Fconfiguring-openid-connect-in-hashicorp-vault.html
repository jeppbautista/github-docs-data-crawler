<html><body><div>
<main><div>
<div><nav><ul>
<li>
<a title="GitHub Actions" href="/en/actions">GitHub Actions</a><span>/</span>
</li>
<li>
<a title="Security" href="/en/actions/security-for-github-actions">Security</a><span>/</span>
</li>
<li>
<a title="Security harden deployments" href="/en/actions/security-for-github-actions/security-hardening-your-deployments">Security harden deployments</a><span>/</span>
</li>
<li><a title="OpenID Connect in HashiCorp Vault" href="/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-hashicorp-vault">OpenID Connect in HashiCorp Vault</a></li>
</ul></nav></div>
<div>
<div><div><h1>Configuring OpenID Connect in HashiCorp Vault</h1></div></div>
<div><div><p>Use OpenID Connect within your workflows to authenticate with HashiCorp Vault.</p></div></div>
<div>
<h2>In this article</h2>
<nav><ul>
<li><a href="#overview"><div><span>Overview</span></div></a></li>
<li><a href="#prerequisites"><div><span>Prerequisites</span></div></a></li>
<li><a href="#adding-the-identity-provider-to-hashicorp-vault"><div><span>Adding the identity provider to HashiCorp Vault</span></div></a></li>
<li><a href="#updating-your-github-actions-workflow"><div><span>Updating your GitHub Actions workflow</span></div></a></li>
<li><a href="#further-reading"><div><span>Further reading</span></div></a></li>
</ul></nav>
</div>
<div><div><div>
<h2><a href="#overview">Overview</a></h2>
<p>OpenID Connect (OIDC) allows your GitHub Actions workflows to authenticate with a HashiCorp Vault to retrieve secrets.</p>
<p>This guide gives an overview of how to configure HashiCorp Vault to trust GitHub's OIDC as a federated identity, and demonstrates how to use this configuration in the <a href="https://github.com/hashicorp/vault-action">hashicorp/vault-action</a> action to retrieve secrets from HashiCorp Vault.</p>
<h2><a href="#prerequisites">Prerequisites</a></h2>
<ul>
<li>
<p>To learn the basic concepts of how GitHub uses OpenID Connect (OIDC), and its architecture and benefits, see <a href="/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect">About security hardening with OpenID Connect</a>.</p>
</li>
<li>
<p>Before proceeding, you must plan your security strategy to ensure that access tokens are only allocated in a predictable way. To control how your cloud provider issues access tokens, you <strong>must</strong> define at least one condition, so that untrusted repositories canâ€™t request access tokens for your cloud resources. For more information, see <a href="/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#configuring-the-oidc-trust-with-the-cloud">About security hardening with OpenID Connect</a>.</p>
</li>
</ul>
<h2><a href="#adding-the-identity-provider-to-hashicorp-vault">Adding the identity provider to HashiCorp Vault</a></h2>
<p>To use OIDC with HashiCorp Vault, you will need to add a trust configuration for the GitHub OIDC provider. For more information, see the HashiCorp Vault <a href="https://www.vaultproject.io/docs/auth/jwt">documentation</a>.</p>
<p>To configure your Vault server to accept JSON Web Tokens (JWT) for authentication:</p>
<ol>
<li>
<p>Enable the JWT <code>auth</code> method, and use <code>write</code> to apply the configuration to your Vault.
For <code>oidc_discovery_url</code> and <code>bound_issuer</code> parameters, use <code>https://token.actions.githubusercontent.com</code>. These parameters allow the Vault server to verify the received JSON Web Tokens (JWT) during the authentication process.</p>
<div>
<header><span>Shell</span><pre>vault auth enable jwt
</pre></header><pre><code>vault auth enable jwt
</code></pre>
</div>
<div>
<header><span>Shell</span><pre>vault write auth/jwt/config \
  bound_issuer="https://token.actions.githubusercontent.com" \
  oidc_discovery_url="https://token.actions.githubusercontent.com"
</pre></header><pre><code>vault write auth/jwt/config \
  bound_issuer="https://token.actions.githubusercontent.com" \
  oidc_discovery_url="https://token.actions.githubusercontent.com"
</code></pre>
</div>
</li>
<li>
<p>Configure a policy that only grants access to the specific paths your workflows will use to retrieve secrets. For more advanced policies, see the HashiCorp Vault <a href="https://www.vaultproject.io/docs/concepts/policies">Policies documentation</a>.</p>
<div>
<header><span>Shell</span><pre>vault policy write myproject-production - &lt;&lt;EOF
# Read-only permission on 'secret/data/production/*' path

path "secret/data/production/*" {
  capabilities = [ "read" ]
}
EOF
</pre></header><pre><code>vault policy write myproject-production - &lt;&lt;EOF
<span># </span><span>Read-only permission on <span>'secret/data/production/*'</span> path</span>

path "secret/data/production/*" {
  capabilities = [ "read" ]
}
EOF
</code></pre>
</div>
</li>
<li>
<p>Configure roles to group different policies together. If the authentication is successful, these policies are attached to the resulting Vault access token.</p>
<div>
<header><span>Shell</span><pre>vault write auth/jwt/role/myproject-production -&lt;&lt;EOF
{
  "role_type": "jwt",
  "user_claim": "actor",
  "bound_claims": {
    "repository": "user-or-org-name/repo-name"
  },
  "policies": ["myproject-production"],
  "ttl": "10m"
}
EOF
</pre></header><pre><code>vault write auth/jwt/role/myproject-production -&lt;&lt;EOF
{
  "role_type": "jwt",
  "user_claim": "actor",
  "bound_claims": {
    "repository": "user-or-org-name/repo-name"
  },
  "policies": ["myproject-production"],
  "ttl": "10m"
}
EOF
</code></pre>
</div>
</li>
</ol>
<ul>
<li>
<code>ttl</code> defines the validity of the resulting access token.</li>
<li>Ensure that the <code>bound_claims</code> parameter is defined for your security requirements, and has at least one condition. Optionally, you can also set the <code>bound_subject</code> as well as the <code>bound_audiences</code> parameter.</li>
<li>To check arbitrary claims in the received JWT payload, the <code>bound_claims</code> parameter contains a set of claims and their required values. In the above example, the role will accept any incoming authentication requests from the <code>repo-name</code> repository owned by the <code>user-or-org-name</code> account.</li>
<li>To see all the available claims supported by GitHub's OIDC provider, see <a href="/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#configuring-the-oidc-trust-with-the-cloud">About security hardening with OpenID Connect</a>.</li>
</ul>
<p>For more information, see the HashiCorp Vault <a href="https://www.vaultproject.io/docs/auth/jwt">documentation</a>.</p>
<h2><a href="#updating-your-github-actions-workflow">Updating your GitHub Actions workflow</a></h2>
<p>To update your workflows for OIDC, you will need to make two changes to your YAML:</p>
<ol>
<li>Add permissions settings for the token.</li>
<li>Use the <a href="https://github.com/hashicorp/vault-action"><code>hashicorp/vault-action</code></a> action to exchange the OIDC token (JWT) for a cloud access token.</li>
</ol>
<div>
<p>
When environments are used in workflows or in OIDC policies, we recommend adding protection rules to the environment for additional security. For example, you can configure deployment rules on an environment to restrict which branches and tags can deploy to the environment or access environment secrets. For more information, see <a href="/en/actions/deployment/targeting-different-environments/managing-environments-for-deployment#deployment-protection-rules">Managing environments for deployment</a>.</p>
</div>
<p>To add OIDC integration to your workflows that allow them to access secrets in Vault, you will need to add the following code changes:</p>
<ul>
<li>Grant permission to fetch the token from the GitHub OIDC provider:
<ul>
<li>The workflow needs <code>permissions:</code> settings with the <code>id-token</code> value set to <code>write</code>. This lets you fetch the OIDC token from every job in the workflow.</li>
</ul>
</li>
<li>Request the JWT from the GitHub OIDC provider, and present it to HashiCorp Vault to receive an access token:
<ul>
<li>You can use the <a href="https://github.com/hashicorp/vault-action"><code>hashicorp/vault-action</code></a> action to fetch the JWT and receive the access token from Vault, or you could use the <a href="https://github.com/actions/toolkit/">Actions toolkit</a> to fetch the tokens for your job.</li>
</ul>
</li>
</ul>
<p>This example demonstrates how to use OIDC with the official action to request a secret from HashiCorp Vault.</p>
<h3><a href="#adding-permissions-settings">Adding permissions settings</a></h3>
<p>The job or workflow run requires a <code>permissions</code> setting with <a href="/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token"><code>id-token: write</code></a> to allow GitHub's OIDC provider to create a JSON Web Token for every run. You won't be able to request the OIDC JWT ID token if the <code>permissions</code> for <code>id-token</code> is not set to <code>write</code>, however this value doesn't imply granting write access to any resources, only being able to fetch and set the OIDC token for an action or step to enable authenticating with a short-lived access token. Any actual trust setting is defined using OIDC claims, for more information see <a href="/en/actions/security-for-github-actions/security-hardening-your-deployments/about-security-hardening-with-openid-connect#configuring-the-oidc-trust-with-the-cloud">About security hardening with OpenID Connect</a>.</p>
<p>The <code>id-token: write</code> setting allows the JWT to be requested from GitHub's OIDC provider using one of these approaches:</p>
<ul>
<li>Using environment variables on the runner (<code>ACTIONS_ID_TOKEN_REQUEST_URL</code> and <code>ACTIONS_ID_TOKEN_REQUEST_TOKEN</code>).</li>
<li>Using <code>getIDToken()</code> from the Actions toolkit.</li>
</ul>
<p>If you need to fetch an OIDC token for a workflow, then the permission can be set at the workflow level. For example:</p>
<div>
<header><span>YAML</span><pre>permissions:
  id-token: write # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout
</pre></header><pre><code><span>permissions:</span>
  <span>id-token:</span> <span>write</span> <span># This is required for requesting the JWT</span>
  <span>contents:</span> <span>read</span>  <span># This is required for actions/checkout</span>
</code></pre>
</div>
<p>If you only need to fetch an OIDC token for a single job, then this permission can be set within that job. For example:</p>
<div>
<header><span>YAML</span><pre>permissions:
  id-token: write # This is required for requesting the JWT
</pre></header><pre><code><span>permissions:</span>
  <span>id-token:</span> <span>write</span> <span># This is required for requesting the JWT</span>
</code></pre>
</div>
<p>You may need to specify additional permissions here, depending on your workflow's requirements.</p>
<p>For reusable workflows that are owned by the same user, organization, or enterprise as the caller workflow, the OIDC token generated in the reusable workflow can be accessed from the caller's context.
For reusable workflows outside your enterprise or organization, the <code>permissions</code> setting for <code>id-token</code> should be explicitly set to <code>write</code> at the caller workflow level or in the specific job that calls the reusable workflow.
This ensures that the OIDC token generated in the reusable workflow is only allowed to be consumed in the caller workflows when intended.</p>
<p>For more information, see <a href="/en/actions/using-workflows/reusing-workflows">Reusing workflows</a>.</p>
<div>
<p>
When the <code>permissions</code> key is used, all unspecified permissions are set to <em>no access</em>, with the exception of the metadata scope, which always gets <em>read</em> access. As a result, you may need to add other permissions, such as <code>contents: read</code>. See <a href="/en/actions/security-guides/automatic-token-authentication">Automatic token authentication</a> for more information.</p>
</div>
<h3><a href="#requesting-the-access-token">Requesting the access token</a></h3>
<p>The <code>hashicorp/vault-action</code> action receives a JWT from the GitHub OIDC provider, and then requests an access token from your HashiCorp Vault instance to retrieve secrets. For more information, see the HashiCorp Vault GitHub Action <a href="https://github.com/hashicorp/vault-action">documentation</a>.</p>
<p>This example demonstrates how to create a job that requests a secret from HashiCorp Vault.</p>
<ul>
<li>
<code>VAULT-URL</code>: Replace this with the URL of your HashiCorp Vault.</li>
<li>
<code>VAULT-NAMESPACE</code>: Replace this with the Namespace you've set in HashiCorp Vault. For example: <code>admin</code>.</li>
<li>
<code>ROLE-NAME</code>: Replace this with the role you've set in the HashiCorp Vault trust relationship.</li>
<li>
<code>SECRET-PATH</code>: Replace this with the path to the secret you're retrieving from HashiCorp Vault. For example: <code>secret/data/production/ci npmToken</code>.</li>
</ul>
<div>
<header><span>YAML</span><pre>jobs:
  retrieve-secret:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Retrieve secret from Vault
        uses: hashicorp/vault-action@9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3e2f1a0b
        with:
          method: jwt
          url: VAULT-URL
          namespace: VAULT-NAMESPACE # HCP Vault and Vault Enterprise only
          role: ROLE-NAME
          secrets: SECRET-PATH

      - name: Use secret from Vault
        run: |
          # This step has access to the secret retrieved above; see hashicorp/vault-action for more details.
</pre></header><pre><code><span>jobs:</span>
  <span>retrieve-secret:</span>
    <span>runs-on:</span> <span>ubuntu-latest</span>
    <span>permissions:</span>
      <span>id-token:</span> <span>write</span>
      <span>contents:</span> <span>read</span>
    <span>steps:</span>
      <span>-</span> <span>name:</span> <span>Retrieve</span> <span>secret</span> <span>from</span> <span>Vault</span>
        <span>uses:</span> <span>hashicorp/vault-action@9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3e2f1a0b</span>
        <span>with:</span>
          <span>method:</span> <span>jwt</span>
          <span>url:</span> <span>VAULT-URL</span>
          <span>namespace:</span> <span>VAULT-NAMESPACE</span> <span># HCP Vault and Vault Enterprise only</span>
          <span>role:</span> <span>ROLE-NAME</span>
          <span>secrets:</span> <span>SECRET-PATH</span>

      <span>-</span> <span>name:</span> <span>Use</span> <span>secret</span> <span>from</span> <span>Vault</span>
        <span>run:</span> <span>|
          # This step has access to the secret retrieved above; see hashicorp/vault-action for more details.
</span></code></pre>
</div>
<div>
<ul>
<li>If your Vault server is not accessible from the public network, consider using a self-hosted runner with other available Vault <a href="https://www.vaultproject.io/docs/auth">auth methods</a>. For more information, see <a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners/about-self-hosted-runners">About self-hosted runners</a>.</li>
<li>
<code>VAULT-NAMESPACE</code> must be set for a Vault Enterprise (including HCP Vault) deployment. For more information, see <a href="https://www.vaultproject.io/docs/enterprise/namespaces">Vault namespace</a>.</li>
</ul>
</div>
<h3><a href="#revoking-the-access-token">Revoking the access token</a></h3>
<p>By default, the Vault server will automatically revoke access tokens when their TTL is expired, so you don't have to manually revoke the access tokens. However, if you do want to revoke access tokens immediately after your job has completed or failed, you can manually revoke the issued token using the <a href="https://www.vaultproject.io/api/auth/token#revoke-a-token-self">Vault API</a>.</p>
<ol>
<li>Set the <code>exportToken</code> option to <code>true</code> (default: <code>false</code>). This exports the issued Vault access token as an environment variable: <code>VAULT_TOKEN</code>.</li>
<li>Add a step to call the <a href="https://www.vaultproject.io/api/auth/token#revoke-a-token-self">Revoke a Token (Self)</a> Vault API to revoke the access token.</li>
</ol>
<div>
<header><span>YAML</span><pre>jobs:
  retrieve-secret:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Retrieve secret from Vault
        uses: hashicorp/vault-action@9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3e2f1a0b
        with:
          exportToken: true
          method: jwt
          url: VAULT-URL
          role: ROLE-NAME
          secrets: SECRET-PATH

      - name: Use secret from Vault
        run: |
          # This step has access to the secret retrieved above; see hashicorp/vault-action for more details.

      - name: Revoke token
        # This step always runs at the end regardless of the previous steps result
        if: always()
        run: |
          curl -X POST -sv -H "X-Vault-Token: ${{ env.VAULT_TOKEN }}" \
            VAULT-URL/v1/auth/token/revoke-self
</pre></header><pre><code><span>jobs:</span>
  <span>retrieve-secret:</span>
    <span>runs-on:</span> <span>ubuntu-latest</span>
    <span>permissions:</span>
      <span>id-token:</span> <span>write</span>
      <span>contents:</span> <span>read</span>
    <span>steps:</span>
      <span>-</span> <span>name:</span> <span>Retrieve</span> <span>secret</span> <span>from</span> <span>Vault</span>
        <span>uses:</span> <span>hashicorp/vault-action@9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3e2f1a0b</span>
        <span>with:</span>
          <span>exportToken:</span> <span>true</span>
          <span>method:</span> <span>jwt</span>
          <span>url:</span> <span>VAULT-URL</span>
          <span>role:</span> <span>ROLE-NAME</span>
          <span>secrets:</span> <span>SECRET-PATH</span>

      <span>-</span> <span>name:</span> <span>Use</span> <span>secret</span> <span>from</span> <span>Vault</span>
        <span>run:</span> <span>|
          # This step has access to the secret retrieved above; see hashicorp/vault-action for more details.
</span>
      <span>-</span> <span>name:</span> <span>Revoke</span> <span>token</span>
        <span># This step always runs at the end regardless of the previous steps result</span>
        <span>if:</span> <span>always()</span>
        <span>run:</span> <span>|
          curl -X POST -sv -H "X-Vault-Token: ${{ env.VAULT_TOKEN }}" \
            VAULT-URL/v1/auth/token/revoke-self
</span></code></pre>
</div>
<h2><a href="#further-reading">Further reading</a></h2>
<ul>
<li><a href="/en/actions/deployment/security-hardening-your-deployments/using-openid-connect-with-reusable-workflows">Using OpenID Connect with reusable workflows</a></li>
<li><a href="/en/actions/hosting-your-own-runners/managing-self-hosted-runners/communicating-with-self-hosted-runners">Communicating with self-hosted runners</a></li>
</ul>
</div></div></div>
</div>
</div></main>
</div></body></html>